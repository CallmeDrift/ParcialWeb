const fs = require('fs')
const path = require('path')

// Path generated by jest --coverage
const summaryPath = path.join(__dirname, '..', 'coverage', 'coverage-summary.json')

if (!fs.existsSync(summaryPath)) {
  console.error('No se encontró coverage-summary.json. Ejecuta `jest --coverage` primero.')
  process.exit(2)
}

const raw = fs.readFileSync(summaryPath, 'utf8')
const data = JSON.parse(raw)

// coverage-summary.json contains entries per file and a 'total' entry
const total = data.total
if (!total) {
  console.error('coverage-summary.json no contiene la sección total.')
  process.exit(2)
}

// percentages are numbers
const statements = total.statements.pct
const branches = total.branches.pct
const functions = total.functions.pct
const lines = total.lines.pct

// Compute an overall percentage as the average of the 4 metrics
const overall = (statements + branches + functions + lines) / 4

// Optionally enforce a minimum threshold via env var COVERAGE_THRESHOLD
const thresholdEnv = process.env.COVERAGE_THRESHOLD
if (thresholdEnv) {
  const threshold = Number(thresholdEnv)
  if (!Number.isFinite(threshold)) {
    console.warn('COVERAGE_THRESHOLD no es un número válido, ignorando.')
    process.exit(0)
  }

  if (overall < threshold) {
    console.error(`Coverage ${pct}% es menor que el umbral requerido ${threshold}%`) 
    process.exit(1)
  } else {
    console.log(`Coverage cumple el umbral de ${threshold}%`) 
  }
}

process.exit(0)
